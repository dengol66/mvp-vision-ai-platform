# Training Infrastructure Values
# This chart provides common infrastructure for all training frameworks.

# Namespace for training jobs
namespace: training

# Docker registry configuration
registry:
  url: ghcr.io/vision-ai
  # Default image tag (can be overridden per-framework in frameworks section)
  defaultTag: latest
  # Image pull secret name (optional, for private registries)
  pullSecret: ""

# Service Account for training jobs
serviceAccount:
  create: true
  name: training-job-sa
  annotations: {}

# RBAC configuration
rbac:
  create: true

# Job default settings
job:
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600
  activeDeadlineSeconds: 86400  # 24 hours

# Default resource configuration
resources:
  defaults:
    cpu:
      request: "2"
      limit: "4"
    memory:
      request: 8Gi
      limit: 16Gi
    gpu:
      limit: "1"

# GPU node configuration
gpu:
  nodeSelector:
    accelerator: nvidia-gpu
  tolerations:
    - key: "nvidia.com/gpu"
      operator: "Exists"
      effect: "NoSchedule"

# Storage configuration
storage:
  # PVC for datasets (read-only access for trainers)
  datasets:
    enabled: false
    pvcName: datasets-pvc
    mountPath: /data/datasets
    readOnly: true

  # PVC for training outputs
  outputs:
    enabled: false
    pvcName: training-outputs-pvc
    mountPath: /data/outputs
    readOnly: false

  # PVC for checkpoints
  checkpoints:
    enabled: false
    pvcName: checkpoints-pvc
    mountPath: /data/checkpoints
    readOnly: false

# S3/MinIO configuration (injected as env vars)
s3:
  enabled: true
  # Secret containing S3 credentials
  secretName: training-s3-credentials
  # These are stored in the secret, not in ConfigMap
  # endpoint: http://minio:9000
  # bucket: models

# MLflow tracking
mlflow:
  enabled: false
  trackingUri: http://mlflow:5000

# Framework-specific configurations
# Each framework can override:
#   - image (full image path) OR image_suffix + optional image_tag
#   - memory request/limit
#   - extra environment variables
#   - extra volumes and volume mounts
frameworks:
  ultralytics:
    enabled: true
    image_suffix: trainer-ultralytics
    # image_tag: v2.0.0  # Optional: override default tag
    resources:
      memory:
        request: 8Gi
        limit: 16Gi
    extra_env: []
    extra_volumes: []
    extra_volume_mounts: []

  huggingface:
    enabled: true
    image_suffix: trainer-huggingface
    # image_tag: v1.3.0  # Optional: override default tag
    resources:
      memory:
        request: 16Gi
        limit: 32Gi
    extra_env:
      - name: HF_HOME
        value: /tmp/huggingface
      - name: TRANSFORMERS_CACHE
        value: /tmp/huggingface/transformers
    extra_volumes:
      - name: hf-cache
        emptyDir:
          sizeLimit: 10Gi
    extra_volume_mounts:
      - name: hf-cache
        mountPath: /tmp/huggingface

  timm:
    enabled: true
    image_suffix: trainer-timm
    # image_tag: v1.1.0  # Optional: override default tag
    resources:
      memory:
        request: 8Gi
        limit: 16Gi
    extra_env: []
    extra_volumes: []
    extra_volume_mounts: []

  custom:
    enabled: true
    # Custom framework uses user-provided image, no image_suffix
    resources:
      memory:
        request: 8Gi
        limit: 16Gi
    extra_env: []
    extra_volumes: []
    extra_volume_mounts: []

# Pod security context
podSecurityContext:
  fsGroup: 1000

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
