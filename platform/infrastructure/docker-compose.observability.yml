# ================================
# Vision AI Training Platform - Observability Services
# ================================
#
# Optional observability tools for experiment tracking and monitoring:
#   - ClearML (experiment tracking, model registry)
#   - MLflow (alternative experiment tracking)
#   - Loki (log aggregation)
#   - Grafana (visualization)
#
# Usage:
#   # Start with main infrastructure
#   docker-compose up -d
#
#   # Add observability services
#   docker-compose -f docker-compose.yml -f docker-compose.observability.yml up -d
#
#   # Or start specific services only
#   docker-compose -f docker-compose.observability.yml up -d clearml-apiserver clearml-webserver clearml-fileserver
#
# Configuration:
#   Set OBSERVABILITY_BACKENDS in .env to choose which tools to use:
#   - "database" = No external tools (Platform DB only)
#   - "clearml,database" = ClearML + Database backup
#   - "mlflow,database" = MLflow + Database backup
#   - "clearml,mlflow,database" = Both + Database backup

version: '3.8'

services:
  # ==========================================
  # ClearML - Experiment Tracking & Model Registry
  # ==========================================

  # Elasticsearch (ClearML dependency)
  clearml-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9
    container_name: clearml-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.name=clearml
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - clearml_elastic_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - platform-network

  # MongoDB (ClearML dependency)
  clearml-mongo:
    image: mongo:7.0
    container_name: clearml-mongo
    restart: unless-stopped
    volumes:
      - clearml_mongo_data:/data/db
    ports:
      - "27018:27017"  # Avoid conflict with other MongoDB instances
    networks:
      - platform-network

  # Redis (ClearML dependency - separate from platform Redis)
  clearml-redis:
    image: redis:7.2-alpine
    container_name: clearml-redis
    restart: unless-stopped
    volumes:
      - clearml_redis_data:/data
    ports:
      - "6380:6379"  # Avoid conflict with platform Redis
    networks:
      - platform-network

  # ClearML API Server
  clearml-apiserver:
    image: allegroai/clearml:latest
    container_name: clearml-apiserver
    restart: unless-stopped
    command: apiserver
    depends_on:
      - clearml-elasticsearch
      - clearml-mongo
      - clearml-redis
    environment:
      CLEARML_ELASTIC_SERVICE_HOST: clearml-elasticsearch
      CLEARML_ELASTIC_SERVICE_PORT: 9200
      CLEARML_MONGODB_SERVICE_HOST: clearml-mongo
      CLEARML_MONGODB_SERVICE_PORT: 27017
      CLEARML_REDIS_SERVICE_HOST: clearml-redis
      CLEARML_REDIS_SERVICE_PORT: 6379
      CLEARML_SERVER_DEPLOYMENT_TYPE: standalone
    volumes:
      - clearml_api_logs:/var/log/clearml
      - clearml_api_config:/opt/clearml/config
    ports:
      - "8008:8008"
    networks:
      - platform-network

  # ClearML Web UI
  clearml-webserver:
    image: allegroai/clearml:latest
    container_name: clearml-webserver
    restart: unless-stopped
    command: webserver
    depends_on:
      - clearml-apiserver
    environment:
      CLEARML_API_HOST: http://clearml-apiserver:8008
    ports:
      - "8080:80"
    networks:
      - platform-network

  # ClearML File Server
  clearml-fileserver:
    image: allegroai/clearml:latest
    container_name: clearml-fileserver
    restart: unless-stopped
    command: fileserver
    volumes:
      - clearml_fileserver_data:/mnt/fileserver
    ports:
      - "8081:8081"
    networks:
      - platform-network

  # ==========================================
  # MLflow - Alternative Experiment Tracking
  # ==========================================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.10.0
    container_name: platform-mlflow
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_BACKEND_STORE_URI=postgresql://admin:devpass@postgres-platform:5432/platform
      - MLFLOW_ARTIFACT_ROOT=s3://mlflow-artifacts
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - MLFLOW_S3_ENDPOINT_URL=http://minio-results:9000
    command: >
      mlflow server
      --backend-store-uri postgresql://admin:devpass@postgres-platform:5432/platform
      --default-artifact-root s3://mlflow-artifacts
      --host 0.0.0.0
      --port 5000
    networks:
      - platform-network
    # Note: Requires postgres-platform and minio-results from main docker-compose.yml

  # ==========================================
  # Loki - Log Aggregation
  # ==========================================
  loki:
    image: grafana/loki:2.9.3
    container_name: platform-loki
    restart: unless-stopped
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
    networks:
      - platform-network

  # ==========================================
  # Grafana - Visualization
  # ==========================================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: platform-grafana
    restart: unless-stopped
    ports:
      - "3200:3000"  # Use 3200 to avoid conflict with Next.js frontend
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
      GF_INSTALL_PLUGINS: ""
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - loki
    networks:
      - platform-network

# ==========================================
# Volumes
# ==========================================
volumes:
  # ClearML
  clearml_elastic_data:
    driver: local
  clearml_mongo_data:
    driver: local
  clearml_redis_data:
    driver: local
  clearml_api_logs:
    driver: local
  clearml_api_config:
    driver: local
  clearml_fileserver_data:
    driver: local

  # Loki & Grafana
  loki_data:
    driver: local
  grafana_data:
    driver: local

# ==========================================
# Networks
# ==========================================
networks:
  platform-network:
    external: true
    name: platform-network
